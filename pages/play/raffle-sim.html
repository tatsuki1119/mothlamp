<style>
    h1 {
        font-size: 1.4rem;
        margin-bottom: 0.2rem;
        color: #ffffff;
    }

    .controls {
        display: flex;
        gap: 8px;
        margin: 10px 0 16px 0;
        align-items: center;
        flex-wrap: wrap;
    }

    button {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #444;
        background: #1e1e1e;
        color: #eee;
        cursor: pointer;
        transition: background 0.2s, transform 0.1s;
    }

    button:hover {
        background: #2a2a2a;
    }

    button.primary {
        background: #2b8cff;
        color: #fff;
        border-color: #1f6fd6;
    }

    button.primary:hover {
        background: #1f6fd6;
    }

    button.danger {
        background: #ff5f5f;
        color: #fff;
        border-color: #d64c4c;
    }

    button.danger:hover {
        background: #d64c4c;
    }

    .panel {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 12px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th,
    td {
        padding: 6px 8px;
        text-align: left;
        border-bottom: 1px solid #333;
    }

    th {
        color: #aaa;
    }

    .progress {
        height: 12px;
        border-radius: 999px;
        overflow: hidden;
    }

    .bar {
        height: 100%;
        background: #2b8cff;
        width: 0;
        transition: width 0.3s ease;
    }

    .history {
        overflow: auto;
        padding: 6px;
        border-radius: 6px;
        border: 1px solid #2a2a2a;
    }

    .result-item {
        padding: 8px 10px;
        border-radius: 6px;
        margin: 6px 0;
        border: 1px solid #2a2a2a;
        color: #f0f0f0;
    }

    .flex {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .right {
        margin-left: auto;
    }

    small {
        color: #999;
    }

    strong {
        color: #fff;
    }

    a {
        color: #2b8cff;
    }
</style>

<div class="contents_block">
    <h1>ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ãã˜ï¼ˆã‚¬ãƒãƒ£ï¼‰ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
</div>


<div class="panel contents_block">
    <strong>æ“ä½œ</strong>
    <div class="controls">
        <div>
            <button class="draw-btn primary" data-count="1">è³¼å…¥ Ã—1</button>
            <button class="draw-btn primary" data-count="5">è³¼å…¥ Ã—5</button>
            <button class="draw-btn primary" data-count="10">è³¼å…¥ Ã—10</button>
            <button class="draw-btn primary" data-count="30">è³¼å…¥ Ã—30</button>
        </div>
        <div class="right">
            <button id="show-config">ç¢ºç‡ãƒ»æ™¯å“ã‚’è¡¨ç¤º</button>
            <button id="reset" class="danger">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div id="last-results"></div>
</div>

<div class="panel contents_block" id="config-panel" style="display:none">
    <strong>ğŸ¯ è¨­å®š</strong>
    <div id="config-list" style="margin-top:8px;"></div>
</div>

<div class="panel contents_block">
    <strong>ğŸ“Š é›†è¨ˆ</strong>
    <div id="summary"></div>
</div>

<div class="panel contents_block">
    <strong>ğŸ§¾ å±¥æ­´ï¼ˆå…¨ä»¶ï¼‰</strong>
    <div id="history" class="history"></div>
</div>

<script>
    // ===============================
    // ã‚³ãƒ³ãƒ•ã‚£ã‚°è¨­å®šéƒ¨åˆ†
    // ===============================
    const GACHA_CONFIG = [
        {
            name: "Aè³ ã€ãƒ¡ãƒ³ãƒãƒ¼å…¨å“¡ã®ç›´ç­†ã‚µã‚¤ãƒ³å…¥ã‚Šï¼ã€‘å¸ƒãƒã‚¹ã‚¿ãƒ¼",
            prob: 0.1,
            items: [
                { name: "A-å¸ƒãƒã‚¹ã‚¿ãƒ¼" }
            ]
        },
        {
            name: "Bè³ ã€ç›´ç­†ã‚µã‚¤ãƒ³å…¥ã‚Šï¼ã€‘ãƒ—ãƒªãƒ³ãƒˆãƒã‚§ã‚­",
            prob: 0.3,
            items: [
                { name: "B-ã‚‚ãª" },
                { name: "B-ç¾é›¨" },
                { name: "B-å‡›èŠ±" },
                { name: "B-ç™¾èŠ±" },
            ]
        },
        {
            name: "Cè³ ãƒ•ãƒ¬ãƒ¼ã‚¯ã‚¢ã‚¯ãƒªãƒ«ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼",
            prob: 5.0,
            items: [
                { name: "C-ã‚‚ãª" },
                { name: "C-ç¾é›¨" },
                { name: "C-å‡›èŠ±" },
                { name: "C-ç™¾èŠ±" },
            ]
        },
        {
            name: "Dè³ ã‚¢ã‚¯ãƒªãƒ«ã‚¹ã‚¿ãƒ³ãƒ‰",
            prob: 14.1,
            items: [
                { name: "D-ã‚‚ãª1" },
                { name: "D-ã‚‚ãª2" },
                { name: "D-ç¾é›¨1" },
                { name: "D-ç¾é›¨2" },
                { name: "D-å‡›èŠ±1" },
                { name: "D-å‡›èŠ±2" },
                { name: "D-ç™¾èŠ±1" },
                { name: "D-ç™¾èŠ±2" },
            ]
        },
        {
            name: "Eè³ ã‚¹ãƒ†ãƒƒã‚«ãƒ¼",
            prob: 16.0,
            items: [
                { name: "E-ã‚‚ãª" },
                { name: "E-ç¾é›¨" },
                { name: "E-å‡›èŠ±" },
                { name: "E-ç™¾èŠ±" },
            ]
        },
        {
            name: "Fè³ ãƒ–ãƒ­ãƒã‚¤ãƒ‰2æšã‚»ãƒƒãƒˆ",
            prob: 29.5,
            items: [
                { name: "F-ã‚‚ãª1" },
                { name: "F-ã‚‚ãª2" },
                { name: "F-ç¾é›¨1" },
                { name: "F-ç¾é›¨2" },
                { name: "F-å‡›èŠ±1" },
                { name: "F-å‡›èŠ±2" },
                { name: "F-ç™¾èŠ±1" },
                { name: "F-ç™¾èŠ±2" },
            ]
        },
        {
            name: "Gè³ ã‚¯ãƒªã‚¢ã‚«ãƒ¼ãƒ‰",
            prob: 35.0,
            items: [
                { name: "G-ã‚‚ãª1" },
                { name: "G-ã‚‚ãª2" },
                { name: "G-ç¾é›¨1" },
                { name: "G-ç¾é›¨2" },
                { name: "G-å‡›èŠ±1" },
                { name: "G-å‡›èŠ±2" },
                { name: "G-ç™¾èŠ±1" },
                { name: "G-ç™¾èŠ±2" },
                { name: "G-ãƒšã‚¢1" },
                { name: "G-ãƒšã‚¢2" },
                { name: "G-ãƒšã‚¢3" },
                { name: "G-ãƒšã‚¢4" },
                { name: "G-ãƒšã‚¢5" },
                { name: "G-ãƒšã‚¢6" },
            ]
        },
    ];

    const STORAGE_HISTORY_KEY = 'gacha_history_v2';

    function rnd() { return Math.random(); }
    function getHistory() {
        const raw = localStorage.getItem(STORAGE_HISTORY_KEY);
        if (!raw) return [];
        try { return JSON.parse(raw) || []; } catch { return []; }
    }
    function saveHistory(arr) { localStorage.setItem(STORAGE_HISTORY_KEY, JSON.stringify(arr)); }
    function pushHistory(entry) { const h = getHistory(); h.push(entry); saveHistory(h); }

    function buildTierCDF(config) {
        let total = 0;
        for (const t of config) total += (t.prob || 0);
        let acc = 0;
        return config.map(t => {
            const p = (t.prob || 0) / total;
            const low = acc; acc += p;
            return { ...t, probNormalized: p, cdfLow: low, cdfHigh: acc };
        });
    }

    function chooseItemFromTier(tier) {
        const items = tier.items || [];
        let total = 0;
        for (const it of items) total += (it.weight || 1);
        const r = rnd() * total;
        let acc = 0;
        for (const it of items) {
            acc += (it.weight || 1);
            if (r < acc) return it;
        }
        return items[items.length - 1];
    }

    function drawOnce(cdf) {
        const r = rnd();
        for (const t of cdf) {
            if (r >= t.cdfLow && r < t.cdfHigh) {
                const it = chooseItemFromTier(t);
                return { tierName: t.name, prizeName: it.name };
            }
        }
        const last = cdf[cdf.length - 1];
        const it = chooseItemFromTier(last);
        return { tierName: last.name, prizeName: it.name };
    }

    function aggregateCounts(history) {
        const counts = {};
        for (const h of history) counts[h.prizeName] = (counts[h.prizeName] || 0) + 1;
        return counts;
    }

    // ===============================
    // UIæç”»
    // ===============================
    function renderConfig() {
        const cdf = buildTierCDF(GACHA_CONFIG);
        const $c = $('#config-list').empty();
        for (const t of cdf) {
            const pct = (t.probNormalized * 100).toFixed(2) + '%';
            const $tier = $(`
                    <div style="margin-bottom:8px;">
                        <strong>${t.name}</strong> <small>ï¼ˆç¢ºç‡: ${pct}ï¼‰</small>
                        <table style="margin-top:6px;">
                            <thead><tr><th>æ™¯å“</th><th>é‡ã¿</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                `);
            for (const it of t.items) {
                const w = (it.weight || 1);
                $tier.find('tbody').append(`<tr><td>${it.name}</td><td>${w}</td></tr>`);
            }
            $c.append($tier);
        }
    }

    function renderSummary() {
        const history = getHistory();
        const counts = aggregateCounts(history);
        const total = history.length;
        const $s = $('#summary').empty();
        $s.append(`<div style="margin-bottom:8px;"><strong>åˆè¨ˆãƒ‰ãƒ­ãƒ¼æ•°:</strong> ${total}</div>`);
        const cdf = buildTierCDF(GACHA_CONFIG);

        for (const tier of cdf) {
            // â–¼ ã“ã®è³ã®åˆè¨ˆå›æ•°ã‚’è¨ˆç®—
            let tierTotal = 0;
            for (const it of tier.items) {
                tierTotal += counts[it.name] || 0;
            }
            const tierRate = total > 0 ? ((tierTotal / total) * 100).toFixed(2) : '0.00';

            // â–¼ è¦‹å‡ºã—ã«åˆè¨ˆã‚’è¿½åŠ è¡¨ç¤º
            const tierTitle = $(`
            <div style="margin-top:10px;">
                <strong>${tier.name}</strong>
                <small>ï¼ˆè¨­å®šç¢ºç‡: ${(tier.probNormalized * 100).toFixed(2)}%ï¼‰</small><br>
                <small>â†’ å‡ºç¾åˆè¨ˆ: ${tierTotal}å› / å®Ÿæ¸¬: ${tierRate}%</small>
            </div>
        `);

            const $table = $(`<table><thead><tr><th>æ™¯å“</th><th>å›æ•°</th><th>ç¢ºç‡</th></tr></thead><tbody></tbody></table>`);
            for (const it of tier.items) {
                const name = it.name;
                const cnt = counts[name] || 0;
                const pct = total > 0 ? ((cnt / total) * 100).toFixed(2) + '%' : '0%';
                const barW = total > 0 ? (cnt / total * 100) : 0;
                const $tr = $(`
                <tr>
                    <td>${name}</td>
                    <td>${cnt}</td>
                    <td style="width:60%">
                        <div class="progress"><div class="bar" style="width:${barW}%"></div></div> ${pct}
                    </td>
                </tr>
            `);
                $table.find('tbody').append($tr);
            }

            $s.append(tierTitle);
            $s.append($table);
        }
    }

    function renderHistory() {
        const h = getHistory();
        const $h = $('#history').empty();
        if (h.length === 0) { $h.append('<div>å±¥æ­´ã¯ç©ºã§ã™ã€‚</div>'); return; }
        for (const e of h.slice().reverse()) {
            const time = new Date(e.timestamp).toLocaleString();
            $h.append(`<div class="result-item"><div class="flex"><div><strong>${e.prizeName}</strong> <small>ï¼ˆ${e.tierName}ï¼‰</small></div><div class="right"><small>${time}</small></div></div></div>`);
        }
    }

    function renderLastResults(arr) {
        const $d = $('#last-results').empty();
        if (!arr || arr.length === 0) return;
        $d.append('<div><strong>ç›´è¿‘ã®å–å¾—</strong></div>');
        for (const r of arr) {
            $d.append(`<div style="display:inline-block;margin:2px;"><div style="font-size:12px;padding:2px 3px;border-radius:2px;background:#222;border:1px solid #eef;"><div><strong>${r.prizeName}</strong></div><div style="font-size:8px;color:#bbb">${r.tierName}</div></div></div>`);
        }
    }

    function performDraws(count) {
        const cdf = buildTierCDF(GACHA_CONFIG);
        const res = [];
        for (let i = 0; i < count; i++) {
            const r = drawOnce(cdf);
            const entry = { timestamp: new Date().toISOString(), tierName: r.tierName, prizeName: r.prizeName };
            pushHistory(entry);
            res.push(entry);
        }
        return res;
    }

    function resetAll() {
        if (!confirm('æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
        localStorage.removeItem(STORAGE_HISTORY_KEY);
        renderSummary(); renderHistory(); renderLastResults([]);
        alert('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
    }

    // ===============================
    // åˆæœŸåŒ–
    // ===============================
    $(function () {
        renderConfig();
        renderSummary();
        renderHistory();

        $('.draw-btn').on('click', function () {
            const n = parseInt($(this).data('count'));
            const results = performDraws(n);
            renderSummary();
            renderHistory();
            renderLastResults(results.slice(-10).reverse());

            // ğŸ¯ æŠ½é¸çµæœã‚’ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
            const msg = results.map(r => `ãƒ»${r.prizeName}ï¼ˆ${r.tierName}ï¼‰`).join('\n');
            alert(`${n}å›ã®æŠ½é¸çµæœï¼š\n\n${msg}`);
        });

        $('#show-config').on('click', function () {
            $('#config-panel').toggle();
            $(this).text($('#config-panel').is(':visible') ? 'ç¢ºç‡ã‚’éš ã™' : 'ç¢ºç‡ãƒ»æ™¯å“ã‚’è¡¨ç¤º');
        });

        $('#reset').on('click', resetAll);
    });
</script>
</body>

</html>
