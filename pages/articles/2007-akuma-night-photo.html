<div id="page-title" style="display: none;">悪魔 Night Duel Buster 写真まとめ [誘蛾灯の導き]</div>

<div class="contents_block">
    <h1 class="glitch-text">悪魔 Night Duel Buster 写真まとめ</h1>
    <p>2024.12.17 @Spotify O-EAST</p>
    <hr class="hr-no-margin">
    <p>本ページでは、皆さんのライブ写真投稿をまとめて紹介しています。</p>
    <p>X(Twitter)の規約により、埋め込み機能の利用は許可されているものとなるため、もしこちらに掲載されていない素晴らしい動画の投稿がありましたら、<a
            href="https://docs.google.com/forms/d/e/1FAIpQLSeYnb-Dzz8GzbTGnGxkTrUmql5CeSQ0s3JTGsfguZM1mjUe9A/viewform?usp=header">こちらのフォーム</a>より該当投稿のURLをお送りいただけると嬉しいです。確認次第追加いたします。ご自分の投稿でも、他の方の投稿でもOKです！
    </p>
</div>

<div class="contents_block contents_block_has_a">
    <a class="contents_block_a" href="?p=akuma-night"></a>
    <h3>動画のまとめページはこちら</h3>
</div>

<div class="contents_block">
    <p>セットリスト</p>
    <ul class="setlist-ul">
        <li><svg role="img" aria-label="蝶々" width="20" height="20">
                <use href="#butterfly"></use>
            </svg>
            <p>ゾクゾク</p>
        </li>
        <li><svg role="img" aria-label="蝶々" width="20" height="20">
                <use href="#butterfly"></use>
            </svg>
            <p>魔性少女</p>
        </li>
        <li><svg role="img" aria-label="蝶々" width="20" height="20">
                <use href="#butterfly"></use>
            </svg>
            <p>花喰み</p>
        </li>
        <li><svg role="img" aria-label="蝶々" width="20" height="20">
                <use href="#butterfly"></use>
            </svg>
            <p>乙女心中</p>
        </li>
        <li><svg role="img" aria-label="蝶々" width="20" height="20">
                <use href="#butterfly"></use>
            </svg>
            <p>おともだち</p>
        </li>
        <li><svg role="img" aria-label="蝶々" width="20" height="20">
                <use href="#butterfly"></use>
            </svg>
            <p>好き好き大好き（戸川純）</p>
        </li>
        <li><svg role="img" aria-label="蝶々" width="20" height="20">
                <use href="#butterfly"></use>
            </svg>
            <p>キミと××××したいだけ</p>
        </li>
    </ul>
</div>

<div class="contents_block">
    <div id="filters">
        <p>フィルタ</p>
        <div class="filter-group">
            <div class="filter-toggle" data-key="mona">もな</div>
            <div class="filter-toggle" data-key="miu">美雨</div>
            <div class="filter-toggle" data-key="rinka">凛花</div>
            <div class="filter-toggle" data-key="hisui">灯翠</div>
            <div class="filter-toggle" data-key="moka">百花</div>
            <div class="filter-toggle" data-key="all">全員</div>
        </div>
        <button id="apply-filters">適用</button>
        <button id="reset-filters">すべて外す</button>
    </div>

</div>


<div id="xposts-loading" class="contents_block">
    <div class="list-loading">
        <svg role="img" aria-label="リボン">
            <use href="#butterfly"></use>
        </svg>
        Loading...
        <svg role="img" aria-label="リボン">
            <use href="#butterfly"></use>
        </svg>
    </div>
</div>

<div id="xposts">
</div>

<script>
    const apiurl = "https://script.google.com/macros/s/AKfycbyWOBPQTSR_-Y4hdSNbY02c8OhkYEwIRJxyjEQ7j58H0Dyqpi4D7IIFVvtW33rFnGIc/exec";
    const target_sheet = "akuma-night-photo";
    const url = apiurl + "?target=" + target_sheet;

    // URLクエリパラメータを取得して解析
    function getFilterParams() {
        const queryParams = new URLSearchParams(window.location.search);
        const filterString = queryParams.get("filter"); // filterパラメータを取得
        return filterString ? filterString.split(".") : []; // ピリオド区切りで配列化
    }

    // URLクエリパラメータを更新
    function updateFilterParams(newFilterArray) {
        const queryParams = new URLSearchParams(window.location.search);
        if (newFilterArray.length > 0) {
            queryParams.set("filter", newFilterArray.join(".")); // フィルタを結合して更新
        } else {
            queryParams.delete("filter"); // 空の場合はfilterパラメータを削除
        }
        const newUrl = `${window.location.pathname}?${queryParams.toString()}`;
        window.history.replaceState(null, "", newUrl);
        return newFilterArray; // 内部利用用
    }

    // 記事データを取得して表示
    $(document).ready(function () {

        // 現在のフィルタを反映
        const activeFilters = getFilterParams(); // getFilterParams() でフィルタのパラメータを取得
        activeFilters.forEach(filter => {
            // data-keyが一致する要素に対してactiveクラスを追加
            $(`.filter-toggle[data-key="${filter}"]`).addClass("active");
        });

        // フィルタのトグル操作
        $('.filter-toggle').on('click', function () {
            $(this).toggleClass("active");
        });

        // フィルタ適用ボタンの処理
        $('#apply-filters').on('click', function () {
            const selectedFilters = $('.filter-toggle.active').map(function () {
                return $(this).data('key');
            }).get();

            updateFilterParams(selectedFilters); // URL を更新
            location.reload(); // ページをリロードしてフィルタを再適用
        });

        // すべてのトグルを外す
        document.getElementById('reset-filters').addEventListener('click', () => {
            document.querySelectorAll('.filter-toggle.active').forEach(toggle => {
                toggle.classList.remove('active');
            });
        });

        // データを取得してフィルタリング
        $.getJSON(url, function (data) {
            const conversionDictionary = {
                'all': '全員',
                'mona': 'もな',
                'miu': '美雨',
                'rinka': '凛花',
                'hisui': '灯翠',
                'moka': '百花'
                // 必要に応じて他のキーと値を追加
            };
            // フィルタをメンバーと曲名で分ける
            const memberFilters = activeFilters.filter(filterKey =>
                ['mona', 'miu', 'rinka', 'hisui', 'moka', 'all'].includes(filterKey)
            );
            const filteredData = data.filter(data_i => {
                // メンバーのOR条件
                const matchesMembers = memberFilters.length === 0 || memberFilters.some(filterKey => {
                    return data_i[filterKey] === "o"; // 値が "o" の場合フィルタ条件を満たす
                });

                // AND条件（両方を満たす場合のみ表示）
                return matchesMembers;
            });

            if (filteredData.length === 0) {
                $('#xposts').append(`
                    <div class="contents_block">
                        <p>条件に一致するデータがありません。</p>
                    </div>
                `);
            } else {
                filteredData.forEach(data_i => {
                    const transformedValues = Object.keys(data_i)
                        .filter(key => data_i[key] === 'o')  // 値が "o" のキーをフィルタ
                        .map(key => conversionDictionary[key] || key)  // 辞書に基づいて変換。無い場合は元のキー
                        .join(', ');  // カンマ区切りで結合

                    const listItem = `
                        <div class="contents_block twitter-container">
                            <p>${transformedValues}</p>
                            <a class="twitter-tweet-data" href="${data_i.url}"></a>
                        </div>
                    `;
                    $('#xposts').append(listItem);
                });
            }

            $('#xposts-loading').hide();
        });
    });
</script>

<style>
    .twitter-container>div {
        margin: 0 auto;
    }

    .filter-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
    }

    .filter-toggle {
        padding: 4px 10px;
        border: 1px solid #757575;
        border-radius: 5px;
        background-color: #391515;
        /* OFF */
        color: #999999;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.3s, color 0.3s;
    }

    .filter-toggle.active {
        background-color: rgb(137, 12, 12);
        /* ON */
        border-color: #e8e8e8;
        color: #ffffff;
    }

    #apply-filters,
    #reset-filters {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        background-color: #7f7f7f;
        color: #ffffff;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
    }

    #reset-filters {
        padding: 4px 10px;
        margin-left: 10px;
    }

    #apply-filters:hover,
    #reset-filters:hover {
        background-color: #9a9a9a;
        transform: scale(1.05);
    }

    #apply-filters:active,
    #reset-filters:active {
        transform: scale(0.95);
    }
</style>
