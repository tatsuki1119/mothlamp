<style>
    .calendar-wrapper {
        margin: auto;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
    }

    .dow {
        text-align: center;
        font-weight: bold;
        padding: 6px 0;
        border-bottom: 1px solid #ffffff22;
    }

    .day {
        border: 1px solid #ffffff22;
        min-height: 100px;
        font-size: 0.6em;
    }

    .day.empty {
        border: none;
        background: transparent;
    }

    .day-number {
        font-weight: bold;
        margin-bottom: 4px;
    }

    .event {
        font-size: 0.75em;
        margin-bottom: 4px;
        line-height: 1.3;
    }

    .event a {
        color: inherit;
        text-decoration: none;
        opacity: 0.9;
    }

    .event a:hover {
        text-decoration: underline;
        opacity: 1;
    }
</style>

<div class="calendar-wrapper">
    <div class="contents_block">
        <div class="calendar-header">
            <button id="prev-month">‹</button>
            <h2 id="calendar-title"></h2>
            <button id="next-month">›</button>
        </div>
    </div>

    <div class="contents_block">
        <div class="calendar-grid">
            <div class="dow">Sun</div>
            <div class="dow">Mon</div>
            <div class="dow">Tue</div>
            <div class="dow">Wed</div>
            <div class="dow">Thu</div>
            <div class="dow">Fri</div>
            <div class="dow">Sat</div>
        </div>

        <div id="calendar-days" class="calendar-grid"></div>
    </div>

</div>

<script>
    $(function () {
        let scheduleData = [];
        let currentYear;
        let currentMonth;

        const apiurl = "https://g-api.mothlamp.info/api?target=schedule";

        function isSameDay(dateStr, year, month, day) {
            const d = new Date(dateStr);
            return (
                d.getFullYear() === year &&
                d.getMonth() === month &&
                d.getDate() === day
            );
        }


        // =========================
        // データ取得
        // =========================
        $.getJSON(apiurl, function (data) {
            scheduleData = data;

            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth(); // 0始まり

            renderCalendar(currentYear, currentMonth);
            bindNav();
        });

        // =========================
        // カレンダー描画
        // =========================
        function renderCalendar(year, month) {
            $('#calendar-days').empty();
            $('#calendar-title').text(`${year}.${String(month + 1).padStart(2, '0')}`);

            const firstDay = new Date(year, month, 1).getDay(); // 日曜始まり
            const totalDays = new Date(year, month + 1, 0).getDate();

            // 空白セル
            for (let i = 0; i < firstDay; i++) {
                $('#calendar-days').append('<div class="day empty"></div>');
            }

            for (let d = 1; d <= totalDays; d++) {
                const dayEvents = scheduleData.filter(e =>
                    isSameDay(e.date, year, month, d)
                );

                let html = `
        <div class="day">
            <div class="day-number">${d}</div>
    `;

                dayEvents.forEach(e => {
                    html += `
            <div class="event">
                <a href="/?p=schedule_detail&sc=${e.index}">
                    【${String(e.tag).toUpperCase()}】${e.title}
                </a>
            </div>
        `;
                });

                html += '</div>';
                $('#calendar-days').append(html);
            }
        }

        // =========================
        // 月切り替え
        // =========================
        function bindNav() {
            $('#prev-month').on('click', function () {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar(currentYear, currentMonth);
            });

            $('#next-month').on('click', function () {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar(currentYear, currentMonth);
            });
        }
    });
</script>
